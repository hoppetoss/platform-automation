name: Create New FastAPI Service for GitOps

on:
  workflow_dispatch:
    inputs:
      service_name:
        description: "Name of the new FastAPI service (e.g., orders-service)"
        required: true
      environment:
        description: "Deployment environment (e.g., dev, staging, prod)"
        required: false
        default: "dev"

jobs:
  create:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout automation repo
        uses: actions/checkout@v4

      - name: Install GitHub CLI
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y gh

      - name: Authenticate GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "$GH_TOKEN" | gh auth login --with-token
          gh auth status

      - name: Create new repo from FastAPI template
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          SERVICE_NAME: ${{ github.event.inputs.service_name }}
        run: |
          echo "üöÄ Creating new FastAPI service: $SERVICE_NAME"
          gh repo create hoppetoss/$SERVICE_NAME \
            --template hoppetoss/template-fastapi-service \
            --public \
            -y || echo "‚ö†Ô∏è Repo already exists, skipping creation"
          echo "‚úÖ Repository ready: https://github.com/hoppetoss/$SERVICE_NAME"

      - name: Configure .env for new service
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          SERVICE_NAME: ${{ github.event.inputs.service_name }}
          ENVIRONMENT: ${{ github.event.inputs.environment }}
        run: |
          gh repo clone hoppetoss/$SERVICE_NAME
          cd $SERVICE_NAME

          cat <<EOF > .env
SERVICE_NAME=$SERVICE_NAME
ENVIRONMENT=$ENVIRONMENT
OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4318/v1/traces
EOF

          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .env
          git commit -m "Add environment configuration" || echo "No changes to commit"
          git push origin main || git push origin master || echo "Push skipped (possibly no changes)"

      # STEP 1 ‚Äî Add Helm values file in platform-infra
      - name: Register Helm values in platform-infra
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          SERVICE_NAME: ${{ github.event.inputs.service_name }}
        run: |
          git clone https://github.com/hoppetoss/platform-infra.git
          cd platform-infra/helm/fastapi-service

          cat <<EOF > values-${SERVICE_NAME}.yaml
namespace: ${SERVICE_NAME}
serviceName: ${SERVICE_NAME}
image:
  repository: hoppetoss/${SERVICE_NAME}
  tag: latest
otel:
  endpoint: "http://otel-collector.observability.svc.cluster.local:4318/v1/traces"
EOF

          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add values-${SERVICE_NAME}.yaml
          git commit -m "Add Helm values for ${SERVICE_NAME}" || echo "No changes"
          git remote set-url origin https://${GH_TOKEN}@github.com/hoppetoss/platform-infra.git
          git push origin main || echo "Push skipped"

      # STEP 2 ‚Äî Register Argo CD Application in platform-infra
      - name: Register service in platform-infra for GitOps
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          SERVICE_NAME: ${{ github.event.inputs.service_name }}
        run: |
          cd platform-infra/argo-apps

          cat <<EOF > ${SERVICE_NAME}-app.yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: ${SERVICE_NAME}
  namespace: argocd
spec:
  project: default
  source:
    repoURL: 'https://github.com/hoppetoss/platform-infra.git'
    targetRevision: main
    path: helm/fastapi-service
    helm:
      valueFiles:
        - values-${SERVICE_NAME}.yaml
  destination:
    server: https://kubernetes.default.svc
    namespace: ${SERVICE_NAME}
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
EOF

          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add ${SERVICE_NAME}-app.yaml
          git commit -m "Add Argo CD app for ${SERVICE_NAME}" || echo "No changes"
          git remote set-url origin https://${GH_TOKEN}@github.com/hoppetoss/platform-infra.git
          git push origin main || echo "Push skipped"

      - name: Output success
        run: |
          echo "üéâ FastAPI service ready!"
          echo "üîó Repo: https://github.com/hoppetoss/${{ github.event.inputs.service_name }}"
          echo "üß© GitOps registered: platform-infra/argo-apps/${{ github.event.inputs.service_name }}-app.yaml"