name: Create New FastAPI Service

on:
  workflow_dispatch:
    inputs:
      service_name:
        description: "Name of the new FastAPI service (e.g., orders-service)"
        required: true
      environment:
        description: "Deployment environment (e.g., dev, staging, prod)"
        required: false
        default: "dev"

jobs:
  create:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
      id-token: write

    steps:
      - name: Checkout automation repo
        uses: actions/checkout@v4

      - name: Verify GitHub authentication
        env:
          GH_TOKEN: ${{ github.token }}
        run: gh auth status || echo "Authenticated using GITHUB_TOKEN"

      - name: Try creating new repo from FastAPI template
        env:
          GH_TOKEN: ${{ github.token }}
          SERVICE_NAME: ${{ github.event.inputs.service_name }}
        run: |
          echo "ðŸš€ Creating new FastAPI service: $SERVICE_NAME"
          gh repo create hoppetoss/$SERVICE_NAME \
            --template hoppetoss/template-fastapi-service \
            --public \
            -y || echo "âš ï¸ Repo creation not permitted, skipping"

          echo "âœ… Repository ready or already existed: https://github.com/hoppetoss/$SERVICE_NAME"

      - name: Clone and configure repo
        env:
          GH_TOKEN: ${{ github.token }}
          SERVICE_NAME: ${{ github.event.inputs.service_name }}
          ENVIRONMENT: ${{ github.event.inputs.environment }}
        run: |
          gh repo clone hoppetoss/$SERVICE_NAME
          cd $SERVICE_NAME

          echo "SERVICE_NAME=$SERVICE_NAME" > .env
          echo "ENVIRONMENT=$ENVIRONMENT" >> .env
          echo "OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4318/v1/traces" >> .env

          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          git add .env
          git commit -m "Add environment configuration" || echo "No changes to commit"
          git push origin master || echo "Push skipped (possibly no changes)"

      - name: Output success
        run: |
          echo "ðŸŽ‰ FastAPI service ready:"
          echo "ðŸ”— https://github.com/hoppetoss/${{ github.event.inputs.service_name }}"